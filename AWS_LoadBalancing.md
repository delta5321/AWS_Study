# 📘 AWS High Availability Architecture: ELB & Auto Scaling

**Project:** 고가용성(High Availability) 웹 서비스 아키텍처 구축
**Role:** SysOps / Cloud Engineer
**Goal:** 단일 서버 환경을 **로드밸런서(ALB)**와 **오토스케일링(ASG)**을 결합하여 트래픽에 따라 자동으로 확장되고 장애를 복구하는 아키텍처로 전환한다.

---

## 🏗️ 1. 아키텍처 개요 (Architecture)

*   **Public Subnet:** 로드밸런서(ALB)와 웹 서버(EC2)가 모두 배치됨.
*   **ALB:** 외부 트래픽을 받아 건강한 인스턴스에 분산.
*   **ASG:** CPU 사용률에 따라 인스턴스를 자동으로 생성/삭제하고, ALB 대상 그룹에 자동 등록.

---

## 🛠️ 2. 사전 준비: 골든 이미지(AMI) 생성

오토스케일링이 "복제"할 원본 서버의 이미지를 준비합니다.

1.  **EC2 인스턴스 생성:** Amazon Linux 2023 선택.
2.  **웹 서버 설정 (User Data):**
    ```bash
    #!/bin/bash
    dnf update -y
    dnf install nginx -y
    systemctl start nginx
    systemctl enable nginx  # ★필수: 재부팅 후에도 자동 실행되도록 설정
    echo "<h1>Hello Server</h1>" > /usr/share/nginx/html/index.html
    ```
3.  **AMI 생성:**
    *   실행 중인 인스턴스 우클릭 > **[이미지 및 템플릿]** > **[이미지 생성]**.
    *   **옵션:** `재부팅 안 함(No reboot)`은 해제 권장 (데이터 정합성 확보).

---

## ⚙️ 3. 상세 구축 가이드 (Step-by-Step)

### Step 1: 대상 그룹 (Target Group) 생성
로드밸런서가 트래픽을 던져줄 **'도착지 명단'**을 만듭니다.

*   **메뉴:** EC2 콘솔 > 로드 밸런싱 > **대상 그룹** > **[대상 그룹 생성]**
*   **설정 상세:**
    *   **대상 유형 선택:** `인스턴스 (Instances)`
        *   *이유:* 우리는 EC2 인스턴스를 관리할 것이기 때문입니다.
    *   **대상 그룹 이름:** `MyLab-TG`
    *   **프로토콜/포트:** `HTTP` : `80`
    *   **VPC:** 실습 중인 `MyLabVPC` 선택 **(필수 확인)**
    *   **상태 검사(Health Check):** 경로 `/` (기본값)
*   **대상 등록 단계:**
    *   **아무것도 등록하지 않고 생성합니다.**
    *   *이유:* 나중에 오토스케일링 그룹(ASG)이 자동으로 서버를 만들어 여기에 꽂아줄 것이기 때문입니다. 수동 등록은 불필요합니다.

### Step 2: 로드 밸런서 (ALB) 생성
외부 사용자가 접속할 **'단일 진입점(대문)'**을 만듭니다.

*   **메뉴:** EC2 콘솔 > 로드 밸런싱 > **로드 밸런서** > **[Application Load Balancer 생성]**
*   **설정 상세:**
    *   **체계(Scheme):** `인터넷 경계 (Internet-facing)`
        *   *이유:* 외부 인터넷에서 사용자가 접속해야 하기 때문입니다. (`Internal`은 사내망 전용)
    *   **네트워크 매핑:**
        *   **VPC:** `MyLabVPC`
        *   **매핑:** 반드시 **2개 이상의 가용 영역(AZ)**을 체크하고, 각각 **Public Subnet**을 선택.
        *   *이유:* ALB는 가용성을 위해 최소 2개 이상의 서브넷이 필요하며, 외부 접속을 위해 Public 서브넷에 있어야 합니다.
    *   **보안 그룹:**
        *   `새 보안 그룹 생성` 클릭.
        *   규칙: `HTTP(80)` / 소스: `Anywhere(0.0.0.0/0)`
        *   *이유:* 전 세계 누구나 웹사이트에 접속할 수 있어야 합니다.
    *   **리스너 및 라우팅:**
        *   프로토콜 `HTTP`, 포트 `80`.
        *   **기본 작업:** 드롭다운에서 **`MyLab-TG` (Step 1에서 만든 것)** 선택.
        *   *의미:* "80번 포트로 들어온 모든 요청은 저 명단(TG)에 있는 애들에게 넘겨라."

### Step 3: 시작 템플릿 (Launch Template) 생성
ASG가 서버를 찍어낼 때 사용할 **'건설 설계도'**를 만듭니다.

*   **메뉴:** EC2 콘솔 > 인스턴스 > **시작 템플릿** > **[시작 템플릿 생성]**
*   **설정 상세:**
    *   **템플릿 이름:** `MyLab-LT`
    *   **AMI:** **`내 AMI`** 탭에서 아까 만든 골든 이미지 선택.
    *   **인스턴스 유형:** `t2.micro` (프리 티어 호환)
    *   **키 페어:** 기존 키 페어 선택 (접속 테스트용).
    *   **네트워크 설정:**
        *   **서브넷:** **"템플릿에 포함하지 않음"** 선택. (★중요)
            *   *이유:* 서브넷 위치는 ASG에서 유동적으로 결정해야 하므로, 설계도에 박제하지 않습니다.
        *   **보안 그룹:** 웹 서버용 보안 그룹(`HTTP 80` 허용) 선택.

### Step 4: 오토 스케일링 그룹 (ASG) 생성
실제로 인스턴스를 생성하고 관리할 **'관리자'**를 고용합니다.

*   **메뉴:** EC2 콘솔 > Auto Scaling > **Auto Scaling 그룹** > **[그룹 생성]**
*   **1단계 (이름 및 템플릿):**
    *   시작 템플릿: **`MyLab-LT` (Step 3에서 만든 것)** 선택.
*   **2단계 (네트워크):**
    *   VPC: `MyLabVPC`
    *   **가용 영역 및 서브넷:** **Public Subnet 2개** 모두 선택.
        *   *이유:* 인스턴스가 여러 가용 영역에 골고루 분산되어 생성되도록 합니다.
*   **3단계 (로드 밸런싱 - ★핵심):**
    *   `기존 로드 밸런서에 연결` 선택.
    *   `로드 밸런서 대상 그룹에서 선택` -> **`MyLab-TG`** 지정.
    *   **ELB 상태 확인 켜기 (Turn on ELB health checks):** ✅ **체크(Check)**
        *   *이유:* 이걸 켜야 ALB가 "이 서버 응답 없는데?(500 에러)"라고 판단했을 때, ASG가 해당 서버를 폐기하고 새것으로 교체해줍니다. (안 켜면 서버가 다운돼도 ASG는 모릅니다.)
*   **4단계 (그룹 크기 및 정책):**
    *   **용량:** 원하는 용량 `2`, 최소 `1`, 최대 `4`.
    *   **크기 조정 정책 (Scaling Policy):**
        *   `대상 추적 크기 조정 정책 (Target tracking)` 선택.
        *   지표 유형: `평균 CPU 사용률`.
        *   대상 값: **`30`** (실습을 위해 30%로 낮게 설정).
        *   *의미:* "CPU가 30% 넘으면 바쁜 거니까 서버 늘리고, 30% 밑이면 서버 줄여서 비용 아껴라."

---

## 🧪 4. 검증 (Verification)

### 1. 웹 접속 테스트
*   로드밸런서의 **DNS 이름**(예: `MyLab-ALB-xxx.amazonaws.com`)을 복사하여 브라우저 접속.
*   새로고침 시 서로 다른 인스턴스(IP 또는 호스트네임)가 응답하는지 확인 (라운드 로빈 동작).

### 2. 부하 테스트 (Scale-Out)
*   **SSH 접속:** 생성된 인스턴스 중 하나에 접속.
*   **스트레스 툴 설치 및 실행:**
    ```bash
    sudo dnf install stress -y
    stress --cpu 1 --timeout 600  # CPU 1개를 100% 사용 (10분간)
    ```
*   **모니터링:**
    *   EC2 콘솔에서 인스턴스 개수가 `2대` -> `3대` -> `4대`로 늘어나는지 확인.
    *   부하 종료 후 다시 줄어드는지 확인 (Scale-In).

---

## 🧹 5. 리소스 정리 (Clean Up)
**비용 방지를 위해 반드시 순서대로 삭제하세요.**

1.  **Auto Scaling 그룹 삭제:** 연결된 인스턴스들이 자동으로 종료(`Terminating`)됩니다.
2.  **로드 밸런서(ALB) 삭제:** 시간당 과금이 발생하므로 필수 삭제.
3.  **대상 그룹(Target Group) 삭제.**
4.  **시작 템플릿 및 AMI 삭제.**